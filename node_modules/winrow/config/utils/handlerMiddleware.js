'use strict';

const lodash = require('lodash');
const loggingFactory = require('../logger');
const { isFunction } = lodash;

const handlerMiddleware = (req, res, serviceMethod, input, output) => {
  let args = {};
  if (input) {
    if (isFunction(input.transform)) {
      args = input.transform(req);
    }
  }
  return Promise.resolve(args)
    .then(args => {
      return serviceMethod(args);
    })
    .then(result => {
      if (output) {
        if (isFunction(output.transform)) {
          output.transform = output.transform(res, result)
        }
      }
      return result;
    })
    .catch(err => {
      loggingFactory.error('error', JSON.stringify(err, null, 1));
      const { name, message, statusCode } = err;
      if (statusCode) {
        res.status(statusCode).send({ name: name, message: message })
      }
      return Promise.reject(err);
    })
};

module.exports = handlerMiddleware;