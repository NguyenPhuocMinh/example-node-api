'use strict';

const lodash = require('lodash');
const errorCodes = require('./errorCodes');
const returnCodes = require('./returnCodes');
const loggingFactory = require('./logger');
const { isFunction, get, isEmpty } = lodash;

const handlerMiddleware = (
  req,
  res,
  serviceMethod,
  input,
  output,
) => {
  let args = {};
  let opts = {};
  let response = {};
  if (input) {
    if (isFunction(input.transform)) {
      args = input.transform(req);
    }
  }
  if (output) {
    if (isFunction(output.transform)) {
      response = output.transform();
    }
  }
  return Promise.resolve(args)
    .then(args => {
      opts.loggingFactory = loggingFactory;
      return serviceMethod(args, opts);
    })
    .then(result => {
      if (output) {
        if (isFunction(output.transform)) {
          response = output.transform = output.transform(result);
        }
        response = output.transform;
      }
      return response;
    })
    .then(data => {
      const headers = get(data, 'headers');
      const body = get(data, 'body');
      if (!isEmpty(headers) && !isEmpty(body)) {
        return res
          .set(headers)
          .send(body)
      }
      if (isEmpty(headers) && !isEmpty(body)) {
        return res.send(body)
      }
    })
    .catch(err => {
      if (err instanceof Error) {
        const errorMessage = returnCodes(errorCodes, err.message);
        const statusCode = get(errorMessage, 'statusCode');
        return res.status(statusCode).send(errorMessage)
      }
      const { name, message, statusCode } = err;
      if (statusCode) {
        return res.status(statusCode).send({ name: name, message: message })
      }
      return res.status(500).send(err);
    })
};

module.exports = handlerMiddleware;